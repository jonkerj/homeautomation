---
  - name: Ensure mountpoint is there
    file:
      path: "{{ sunxi_mountpoint }}"
      state: directory
      mode: 0755
  - name: Put Carbon/sunxi in fstab and mount
    mount:
      name: "{{ sunxi_mountpoint }}"
      src: "{{ sunxi_src }}"
      fstype: nfs
      opts: defaults,local_lock=all
      state: mounted
  - name: Put import.sh in the right place
    template:
      src: sunxi-import.sh
      dest: /usr/local/bin/sunxi-import.sh
      mode: 0755
  - name: Install packages
    apt: name={{ item }} state=present
    with_items:
      - ser2net
      - u-boot-tools
      - sysfsutils
  - name: Userspace U-Boot environment config
    template:
      src: fw_env.config
      dest: /etc/fw_env.config
  - name: ser2net configfile
    template:
      src: ser2net.conf
      dest: /etc/ser2net.conf
    notify:
    - restart ser2net
  - name: Install U-boot scripts
    template:
      src: "{{ item }}.cmd"
      dest: "/boot/{{ item }}.cmd"
    with_items:
      - boot
      - patch
    register: scripts
    notify:
    - recompile uboot script
  - name: Prepare GPIO for rebooting
    template:
      src: sunxi-reboot-other.conf
      dest: /etc/sysfs.d/sunxi-reboot-other.conf
    notify:
    - restart sysfsutils
  - name: Reboot script
    template:
      src: sunxi-reboot-other.sh
      dest: /usr/local/sbin/sunxi-reboot-other.sh
      mode: 0755
